---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import FormattedDate from "@components/FormattedDate.astro";
import TableOfContents from '@components/TableOfContents.astro';
import BlogPosting from "@components/BlogPosting.astro";
import ScrollProgress from "@components/ScrollProgress.astro";
import { Image } from 'astro:assets';
import type { MarkdownHeading } from 'astro';
import {
  BlueskyShareButton,
  ThreadsShareButton,
  TwitterShareButton,
  RedditShareButton,
  HackerNewsShareButton,
  SocialShare
} from "astro-social-share";

const BUTTONS = [BlueskyShareButton, ThreadsShareButton, TwitterShareButton, RedditShareButton, HackerNewsShareButton]

type Props = CollectionEntry<"blog">['data'] & { headings: MarkdownHeading[] };

const { title, description, pubDate, updatedDate, tags, headings, related1, related2 } = Astro.props;

const { slug } = Astro.params;

const allPosts = await getCollection("blog");
const relatedPosts = [ related1, related2 ];
const selectedPosts = allPosts.filter(post => 
  relatedPosts.includes(post.id)
);
---

<BaseLayout title={title} description={description}>

  <head>
    <link rel="stylesheet" href="/prism.css" />
  </head>

  <style scoped>
    h1 {
      margin-bottom: 0.125em;
      line-height: 1.1;
    }
    hr {
      margin-top: 1em;
    }
    article {
      margin: 2.5em auto;
    }
    .description {
      margin: 1.5em auto 1.5em ;
    }
    .tag button {
      margin: 0 0.25em;
    }
    .tag button:first-of-type {
      margin-left: 0;
    }
    .date {
      font-size: 0.875em;
      margin-top: 0.5em;
      display: grid;
      grid-template-columns: 3;
      grid-template-rows: 2;
    }
    .last-updated-on {
      display: inline-flex;
      place-items: center;
      color: var(--primary);
      font-family: var(--sub-font);
      font-weight: 500;
    }
    li:hover {
      padding-bottom: 0.25em;
      border-bottom: 2px solid var(--hover);
    }
    form {
      display: flex;
      align-items: center;
    }
    label {
      color: var(--text);
      margin-right: 1em;
    }
    .midline {
      margin-bottom: 1.5em;
    }
    .edit-post {
      display: flex;
      justify-content: space-around;
      color: var(--primary);
      font-family: var(--sub-font);
      font-weight: 700;
      margin: 1em auto;
    }
    .edit-post span {
      margin: 0 auto;
    }
    .gh {
      width: 24px;
      height: 24px;
      margin: 0;
      padding: 0;
    }
    .edit {
      display: inline-block;
      background-color: var(--info);
      color: #000;
      border-radius: 0.5em;
      cursor: pointer;
      font-weight: 700;
      margin: 0 auto;
      padding: 6px 10px;
      text-decoration: none;
      font-size: 0.85em;
      font-family: var(--sub-font);
      line-height: 1.5;
    }
    .edit img {
      display: inline;
      filter: brightness(0) saturate(100%);
      height: 24px;
      width: auto;
      padding: 0 auto;
      margin: 2px 0 -5px 0;
      border-radius: 0;
      cursor: pointer;
    }
    .post-end {
      font-family: var(--sub-font);
      font-weight: 700;
      margin: 0 auto;
      justify-content: space-around;
    }
    .mid-end {
      display: grid;
      place-items: center;
      grid-template-columns: auto auto;
      font-family: var(--sub-font);
      font-weight: 700;
      margin: 0 auto;
      justify-content: space-around;
    }
    .coffee {
      display: grid;
      color: var(--primary);
      grid-template-columns: auto;
      grid-template-rows: auto auto;
      place-items: center;
      gap: 0;
      margin: 0 auto;
      padding: 0 auto;
      cursor: default;
      height: 115px;
    }
    .coffee-btn {
      display: grid;
      background-color: var(--info);
      border-radius: 0.25em;
      font-family: var(--sub-font);
      color: var(--primary);
      grid-template-columns: auto;
      grid-template-rows: auto auto;
      cursor: pointer;
      padding: 0;
      margin-top: 1em;
    }
    .coffee-btn:hover {
      background: var(--menu);
    }
    .share {
      display: grid;
      color: var(--primary);
      grid-template-columns: auto;
      grid-template-rows: auto auto;
      place-items: center;
      gap: 0;
      cursor: default;
      width: 325px;
      height: 130px;
    }
    .umami {
      display: grid;
      color: var(--primary);
      grid-template-columns: auto;
      grid-template-rows: auto auto;
      padding-top: 1em;
      cursor: default;
      width: 325px;
      height: 115px;
      margin-bottom: 1em;
      font-weight: 700;
    }
    .stats {
      display: inline-block;
      background-color: var(--info);
      color: #000;
      border-radius: 0.5em;
      cursor: pointer;
      font-weight: 700;
      margin: 0 auto;
      padding: 1px 10px 0 10px;
      text-decoration: none;
      font-family: var(--sub-font);
    }
    .umami img {
      display: inline;
      filter: brightness(0) saturate(100%);
      height: 24px;
      width: auto;
      padding: 0;
      margin: 0 0 -0.3em 0;
      border-radius: 0;
      cursor: pointer;
    }
    .edit-post a, .stats a, .email a {
      color: #000;
    }
    .email:hover a, .email:focus a {
      color: #000;
    }
    .edit-post a:hover, .stats:hover a {
      color: #000;
    }
    .questions {
      display: grid;
      place-items: center;
      grid-template-columns: auto;
      grid-template-rows: auto;
      width: 325px;
    }
    .questions span {
      font-family: var(--sub-font);
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.65em;
    }
    .email {
      display: inline-flex;
      align-items: center;
      text-align: center;
      border-radius: 0.5em;
      cursor: pointer;
      font-weight: 700;
      margin: 0 auto;
      text-decoration: none;
      font-family: var(--sub-font);
      line-height: 1.5;
      padding-top: 4px;
      padding-bottom: 6px;
      margin-bottom: 1em;
    }
    .email img {
      margin: 1px auto -12px auto;
      width: 25px;
      height: auto;
    }
    aside button:hover {
      background: var(--menu);
    }
    .blog-aside {
      display: inline-flex;
      justify-content: space-between;
      font-size: 1.5em;
      margin: -1em auto 1em auto;
      padding: 0 auto;
      width: 100%;
    }
    .related {
      display: inline;
    }
    .related h3 {
      font-size: 1.5em;
      color: var(--primary);
      margin: 1em 0 1em 0;
    }
    .related ul {
      list-style-type: none;
      padding: 0;
    }
    .related li {
      font-size: 1.15em;
      font-weight: 700;
      border: 2px solid var(--primary);
      background-color: var(--blockquote);
      color: var(--emphasis);
      padding: 1em 1em 0.85em 1em;
      margin: 1em;
      border-radius: 0.5em;
    }
    .related li:hover {
      color: var(--hover);
    }
    @media screen and (max-width: 667px) {
      h1 {
        font-size: 1.35em;
      }
      article {
        margin-bottom: 3em;
      }
      .related li {
        font-size: 1em;
      }
      .edit-post {        
        justify-content: space-around;
        align-content: center;
      }
      .edit-button::before {
        content: "\a";
        white-space: pre;
      }
      .edit {
        margin-top: 0.65em;
        margin-left: 1.25em;
      }
      .post-end, .mid-end {
        display: grid;
        grid-template-columns: auto;
        justify-content: center;
        place-items: center;
        margin: 0 auto -0.75em auto;
        gap: 0 0;
      }
      .coffee {
        grid-row: 1;
        grid-column: 1;
        margin: 0.25em auto -0.25em auto;
        width: auto;
      }
      .coffee span {
        margin-bottom: -0.5em;
      }
      .share {
        grid-row: 2;
        grid-column: 1;
        margin: 0 auto -0.675em auto;
        width: auto;
      }
      .umami {
        width: auto;
        margin: 0 auto 0.15em auto;
      }
      .questions {
        width: auto;
        margin: 0 auto 0.75em auto;
      }
      .questions span {
        margin: 1em auto 0 auto;
      }
      .email {
        margin: 1em auto;
      }
    }
    </style>

  <slot name="astro-social-share-css">
    <style is:global>
      .astro-social-share {
        margin: 0 auto 2em auto;
        height: 24px;
        padding: 0.35em 0 0 0;
      }
      .astro-social-share svg {
        filter: var(--share);
        margin: 0 0.25em;
        width: 32px;
        height: 32px;
      }
      .astro-social-share svg:hover {
        filter: var(--coffee-hover);
      }
    </style>
  </slot>

  <BlogPosting slot="head" {...Astro.props} />

  <ScrollProgress />

  <article data-pagefind-body>
    <h1 class="title">{title}</h1>
    <div>
      <span class="tag">
        {tags.map((tag) => (
          <a href={`/categories/${tag}`} data-umami-event="category-from-article">
            <button>{tag}</button>
          </a>
        ))}
      </span>
    </div>
    <div class="date" data-pagefind-ignore>
      <FormattedDate date={pubDate} />
      {
        updatedDate && (
          <span class="last-updated-on">
            Updated&nbsp;<FormattedDate date={updatedDate} />
          </span>
        )
      }
    </div>
    <hr />
    <p class="description">
      {description}
    </p>
    <TableOfContents headings={headings} />
    <slot>
      <p>
        If you're seeing this, something went wrong! Please try <em
          >reloading the page</em
        >.
      </p>
    </slot>

    <div class="related">
      <h3>Related Articles</h3>
      <ul>
        {selectedPosts.map(post => (
          <a href={`/blog/${post.id}`} rel="prefetch-intent" data-umami-event={`featured-${post.id}`}>
            <li>
              {post.data.title}
            </li>
          </a>
        ))}
      </ul>
    </p>

  </article>
  <hr class="midline">

  <script is:inline src="https://giscus.app/client.js"
    data-theme="https://blog-8c6.pages.dev/giscus.css"
    data-repo="fullmetalbrackets/blog"
    data-repo-id="R_kgDOIBwrhQ"
    data-category="Comments"
    data-category-id="DIC_kwDOIBwrhc4CzE-1"
    data-mapping="title"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>

  <aside class="edit-post">
    <div>
      <span>
        Error in this article?
      </span>
      <span class="edit-button">
        <button class="edit">
          <a 
          href={`https://github.com/fullmetalbrackets/blog/blob/main/src/content/blog/${slug}.md/`}
          target="_blank" data-umami-event={`edit-gh-${slug}`}>
            <img src="/assets/gh.svg"
              class="gh"
              loading="lazy"
              decoding="async"
              alt="Edit this page on GitHub"> <span>Edit on GitHub</span>
          </a>
        </button>
      </span>
    </div>
  </aside>

  <aside class="mid-end">
    <div class="coffee">
      <span>Was this article helpful?</span>
        <a href="https://www.buymeacoffee.com/arieldiaz">
          <Image
            src="https://img.buymeacoffee.com/button-api/?slug=arieldiaz&font_family=Lato&coffee_colour=ffffff"
            class="coffee-btn"
            alt="Buy Me A Coffee"
            title="Buy Me A Coffee"
            loading="lazy"
            decoding="async"
            inferSize={true}
          />
        </a>
    </div>
    <div class="share">
      <span>Want to share this article?</span>
      <SocialShare
        buttons={BUTTONS}
        description={description}
        title={title}
      />
    </div>
  </aside>

  <aside class="post-end">
    <div class="umami">
      <span>
        Want to see article stats?
      </span>
      <button class="stats">
        <span>
          <a 
            href={`https://cloud.umami.is/analytics/us/share/5MdOgBcRzVP6FU0x/fullmetalbrackets.com?path=eq./blog/${slug}/`}
            target="_blank" data-umami-event={`umami-stats-${slug}`}>
              <img src="/assets/umami.svg"
                class="umami"
                loading="lazy"
                decoding="async"
                alt="Umami Analytics"> Umami
          </a>
        </span>
      </button>
    </div>
    <div class="questions">
      <span>Have any questions?</span>
        <button class="email">
          <a 
            href={`mailto:contact@fullmetalbrackets.com?subject=RE: ${title}`}>
              <img src="/assets/email.svg"
                class="email"
                loading="lazy"
                decoding="async"
                alt="Email"> Email Me
          </a>
        </button>
    </div>
  </aside>

  <hr class="endline" />
  <aside class="blog-aside">
    <a href="/blog" class="top blog-tag"><button>&larr; Blog</button></a>
    <a href="/" class="top blog-tag home"><button>&#8626; Home</button></a>
    <a href="#top" class="top blog-tag"><button>Top &uarr;</button></a>
  </aside>

</BaseLayout>