---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Book from '@components/Book.astro';
import Game from '@components/Game.astro';
import ImageCard from '@components/ImageCard.astro';
import Movie from '@components/Movie.astro';
import Note from '@components/Note.astro';
import Quote from '@components/Quote.astro';
import TVShow from '@components/TVShow.astro';
import YouTube from '@components/YouTube.astro';
import BackToTop from '@components/BackToTop.astro';

const items = await getCollection('lifestream');
const sortedItems = items.sort((a, b) => 
  new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const allTypes = ['book', 'game', 'image', 'movie', 'note', 'quote', 'tvshow', 'youtube'] as const;
type LifestreamType = typeof allTypes[number];

const typeCounts = allTypes.reduce((acc, type) => {
  acc[type] = items.filter(item => item.data.type === type).length;
  return acc;
}, {} as Record<LifestreamType, number>);

const activeTypes = allTypes.filter(type => typeCounts[type] > 0);

const typeLabels: Record<LifestreamType, string> = {
  movie: 'Movies',
  tvshow: 'TV Shows',
  book: 'Books',
  game: 'Games',
  quote: 'Quotes',
  note: 'Notes',
  youtube: 'Videos',
  image: 'Images',
};

const title = "Lifestream";
const desc = "A chronicle of things I've experienced, enjoyed or learned from"
---

<BaseLayout title={title} description={desc}>
  <section>
    <div class="title-with-info">
      <h1>{title}</h1>
      <span 
        class="info-button" 
        aria-label="About this page"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <span class="tooltip">
          WTF is a Lifestream?<br><br>It's what I call this page where I chronicle media I've enjoyed, funny or interesting things I've found, and random stuff I wanted to write down.<br><br>It's part digital scrapbook, part recommendation list, and part stream of consciousness. Because I'd rather post random shit on my own website than use most social media.
        </span>
      </span>
    </div>
    <hr />
    <div class="filters" role="group" aria-label="Content type filters">
      {activeTypes.map(type => (
        <button 
          class="filter-btn active" 
          data-filter={type}
          aria-pressed="true"
          type="button"
        >
          <span class="filter-label">{typeLabels[type]}</span>
          <span class="filter-count">{typeCounts[type]}</span>
        </button>
      ))}
    </div>

    <div class="lifestream-grid">
      {sortedItems.map((item, index) => {
        const { type } = item.data;
        return (
          <article 
            class="lifestream-item" 
            data-type={type}
          >
            {type === 'book' && <Book {...item.data as any} index={index} />}
            {type === 'game' && <Game {...item.data as any} index={index} />}
            {type === 'image' && <ImageCard {...item.data as any} index={index} />}
            {type === 'movie' && <Movie {...item.data as any} index={index} />}
            {type === 'note' && <Note {...item.data as any} index={index} />}
            {type === 'quote' && <Quote {...item.data as any} index={index} />}
            {type === 'tvshow' && <TVShow {...item.data as any} index={index} />}
            {type === 'youtube' && <YouTube {...item.data as any} index={index} />}
          </article>
        );
      })}
    </div>
    <div class="empty-state" hidden>
      <p>No items match your current filters. Try enabling some filter buttons above!</p>
    </div>
  </section>
  <hr>
  <BackToTop />
</BaseLayout>

<script>
  import Masonry from 'masonry-layout';
  import imagesLoaded from 'imagesloaded';
  
  type FilterType = 'book' | 'game' | 'image' | 'movie' | 'note' | 'quote' | 'tvshow' | 'youtube';
  
  const filterButtons = document.querySelectorAll<HTMLButtonElement>('.filter-btn');
  const grid = document.querySelector('.lifestream-grid') as HTMLElement;
  const emptyState = document.querySelector<HTMLElement>('.empty-state');
  
  const activeFilters = new Set<FilterType>(
    Array.from(filterButtons).map(btn => btn.dataset.filter as FilterType)
  );

  let msnry: Masonry | null = null;
  let iso: any = null;
  
  async function initMasonry() {
    if (!grid) return;
    
    const Isotope = (await import('isotope-layout')).default;
    
    iso = new Isotope(grid, {
      itemSelector: '.lifestream-item',
      layoutMode: 'masonry',
      masonry: {
        gutter: 32
      },
      transitionDuration: 0,
      hiddenStyle: {
        opacity: 0
      },
      visibleStyle: {
        opacity: 1
      }
    });

    imagesLoaded(grid, () => {
      if (iso) {
        iso.layout();
      }
    });
  }

  function updateVisibleItems() {
    if (!iso) return;
    
    const items = grid.querySelectorAll<HTMLElement>('.lifestream-item');
    let visibleCount = 0;
    const itemsToHide: HTMLElement[] = [];
    const itemsToShow: HTMLElement[] = [];
    
    items.forEach(item => {
      const itemType = item.dataset.type as FilterType;
      const shouldBeVisible = activeFilters.has(itemType);
      const isCurrentlyVisible = item.style.display !== 'none';
      
      if (shouldBeVisible) {
        visibleCount++;
        if (!isCurrentlyVisible) {
          itemsToShow.push(item);
        }
      } else if (isCurrentlyVisible) {
        itemsToHide.push(item);
      }
    });
    
    if (emptyState) {
      if (visibleCount === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }
    }

    itemsToHide.forEach(item => {
      item.classList.add('hiding');
    });
    
    setTimeout(() => {
      itemsToHide.forEach(item => {
        item.style.display = 'none';
        item.classList.remove('hiding');
      });
      
      itemsToShow.forEach(item => {
        item.style.display = '';
      });
      
      if (activeFilters.size === 0) {
        iso.arrange({ filter: () => false });
      } else {
        iso.arrange({
          filter: function(itemElem: HTMLElement) {
            const itemType = itemElem.dataset.type as FilterType;
            return activeFilters.has(itemType);
          }
        });
      }
    }, 250);
  }

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filterType = button.dataset.filter as FilterType;
      if (!filterType) return;
      
      if (activeFilters.has(filterType)) {
        activeFilters.delete(filterType);
        button.classList.remove('active');
        button.setAttribute('aria-pressed', 'false');
      } else {
        activeFilters.add(filterType);
        button.classList.add('active');
        button.setAttribute('aria-pressed', 'true');
      }
      
      updateVisibleItems();
    });
  });

  filterButtons.forEach(button => {
    button.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        button.click();
      }
    });
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonry);
  } else {
    initMasonry();
  }

  let resizeTimer: number;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = window.setTimeout(() => {
      if (iso) {
        iso.layout();
      }
    }, 250);
  });
</script>

<script>
  const infoButton = document.querySelector('.info-button');
  
  if (infoButton) {
    infoButton.addEventListener('click', (e) => {
      e.stopPropagation();
      infoButton.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!infoButton.contains(e.target as Node)) {
        infoButton.classList.remove('active');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        infoButton.classList.remove('active');
      }
    });
  }
</script>

<style>
  .lifestream-container {
    max-width: 75ch;
    margin: 0 auto;
    overflow: hidden;
  }
  
  h1 {
    font-family: var(--sub-font);
    font-weight: 900;
    margin: 0;
  }

  hr {
    margin-bottom: 1.5em;
  }

  p {
    margin: 0 0 2em 0;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    margin: 0 auto 2em auto;
  }
  
  .filter-label {
    font-size: 1em;
  }
  
  .filter-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1rem;
    height: 1rem;
    padding: 1px 0 0 0;
    margin: 0 auto;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 9999px;
    font-family: var(--main-font);
    font-size: 0.75em;
  }
  
  button {
    display: flex;
    background: var(--inactive);
    place-items: center;
    gap: 0.25em;
    margin: 0;
  }

  button.active {
    background: var(--info);
  }

  .filter-btn.active .filter-count {
    background: rgba(0, 0, 0, 0.15);
  }

  .lifestream-grid {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    margin: 0 auto;
    padding: 0;
    overflow: hidden;
    z-index: 10;
  }

  .lifestream-item {
    width: calc(33.333% - 22px);
    margin-bottom: 32px;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
    overflow-y: visible;
    padding-top: 1em;
  }
  
  .lifestream-item * {
    max-width: 100%;
    box-sizing: border-box;
  }
  
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #666;
  }
  
  .empty-state p {
    font-size: 1.125rem;
    margin: 0;
  }

  .title-with-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-button {
    position: relative;
    background: var(--inactive);
    border-radius: 100%;
    padding: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .info-button:hover,
  .info-button:focus {
    background: var(--info);
  }

  .info-button svg {
    color: #000;
  }

  section {
    overflow-x: hidden;
    max-width: 100%;
  }

  .tooltip {
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background-color: rgb(from var(--blockquote, var(--blockquote)) r g b / 0.875);
    border: 1px solid var(--blockquote);
    border-radius: 2em;
    padding: 1rem;
    width: 300px;
    max-width: 90vw;
    font-size: 0.875rem;
    line-height: 1.5;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
    color: var(--text);
    backdrop-filter: blur(0.25em);
    -webkit-backdrop-filter: blur(0.25em);
  }

  .tooltip::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid var(--blockquote);
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid var(--blockquote);
  }

  .info-button:hover, .info-button.active {
    background: var(--info);
    border-color: var(--info);
  }

  .info-button:hover .tooltip,
  .info-button:focus .tooltip {
    opacity: 1;
    visibility: visible;
  }

  .info-button.active .tooltip {
    opacity: 1;
    visibility: visible;
  }

@media (max-width: 768px) {
  .tooltip {
    left: 50%;
    right: auto;
    transform: translateX(-50%);
    width: calc(100vw - 5rem);
    max-width: 320px;
  }

  .tooltip::before,
  .tooltip::after {
    left: 50%;
    right: auto;
    transform: translateX(-50%);
  }
}
  @media (max-width: 1300px) {
    .lifestream-item {
      width: calc(50% - 16px);
    }
  }

  @media (max-width: 768px) {
    .lifestream-item {
      width: 100%;
      margin-bottom: 1.5rem;
    }
    
    .filters {
      margin: -1em auto 1em auto;
      padding: 1rem;
      gap: 0.5rem;
    }
  }
</style>