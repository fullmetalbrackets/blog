---
import BaseLayout from "@layouts/BaseLayout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import FormattedDate from "@components/FormattedDate.astro";
import ReadingTime from "@components/ReadingTime.astro";
import BackToTop from "@components/BackToTop.astro";

export async function getStaticPaths() {
	const allPosts = await getCollection("blog").then((collection) => {
		return collection.sort(
			(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
		);
	});

	const tags: string[] = [];

	allPosts.forEach((post) => {
		post.data.tags.forEach((tag) => {
			tags.push(tag.toLowerCase());
		});
	});

	return await Promise.all(
		Array.from(new Set(tags)).map(async (tag) => {
			const filteredPosts = allPosts.filter((post) =>
				post.data.tags.map((tag) => tag.toLowerCase()).includes(tag),
			);

			// Get reading times for posts in this tag
			const postsWithReadingTime = await Promise.all(
				filteredPosts.map(async (post) => {
					const { remarkPluginFrontmatter } = await render(post);
					return {
						...post,
						readingTime: remarkPluginFrontmatter.readingTime
					};
				})
			);

			return {
				params: { tag },
				props: {
					tag,
					posts: postsWithReadingTime,
				},
			};
		})
	);
}

export interface Props {
	tag: string;
	posts: (CollectionEntry<"blog"> & { readingTime: string })[];
}

const { tag, posts } = Astro.props;
---


<style scoped>
  h1 {
    font-family: var(--sub-font);
    font-weight: 900;
  }
  .back {
    justify-content: left;
    font-family: var(--sub-font);
    font-weight: 500;
    margin: 0;
    padding: 0;
  }
  .back a {
    color: var(--link);
    border-bottom: 1px solid transparent;
  }
  .back a:hover {
    color: var(--hover);
    border-bottom: 1px solid var(--hover);
    transition: all .25s ease-out;
  }
  .info {
    place-items: center;
    margin: 0.1em 0 0 0;
    padding: 0;
    display: inline-flex;
    gap: 0.25em
  }
  .title {
    font-weight: bold;
    color: var(--emphasis);
  }
  ul {
    list-style-type: none;
  }
  li .desc {
    border-bottom: 2px solid transparent;
  }
  li:hover .desc {
    border-bottom: 2px solid var(--hover);
    cursor: pointer;
    transition: all .25s ease-out;
  }
  li:hover .title {
    color: var(--hover);
    transition: all .25s ease-out;
  }
  .date {
    margin: 0;
    padding: 0;
  }
  .desc {
    padding-bottom: 0.25em;
    margin-bottom: 2em;
  }
  .tag {
    margin: 0;
    padding: 0;
    color: var(--primary);
  }
  .tag button {
    margin: 0.25em 0.25em 0.25em 0;
  }
  .back {
    margin-top: 0;
    font-size: 1.35em;
  }
  @media (hover: hover) {
    li:hover button {
      box-shadow: -4px -4px 0 #000;
      transform: translate(4px, 4px);
    }
    li:hover button {
      outline-offset: 1px;
    }
  }
  @media screen and (max-width: 667px) {
    .back {
      margin: 0 0 1em 0;
    }
    ul {
      margin: 0 0 0 -1.5em;
    }
  }
</style>

<BaseLayout title={`${tag}`}>
  <section>
    <h1>Posts about <span class="tag">{`${tag}`}</span></h1>
    <hr />
    <aside class="back">
      <a href="/categories/">&larr; Back to Categories</a>
    </aside>
    <ul>
      {
        posts.map((post) => (
          <li>
            <div>
              <a href={`/blog/${post.id}/`} rel="prefetch-intent">
                <span class="title">{post.data.title}</span>
                <p class="tag">
                  {post.data.tags.map((tag) => (
                    <button>{tag}</button>
                  ))}
                </p>
                <p class="info">
                  <FormattedDate date={post.data.pubDate} />&nbsp;
                  <span class="reading"><ReadingTime time={post.readingTime} /></span>
                </p>
                <p class="desc">{post.data.description}</p>

              </a>
            </div>
          </li>
        ))
      }
    </ul>
    <hr />
    <BackToTop />
  </section>
</BaseLayout>